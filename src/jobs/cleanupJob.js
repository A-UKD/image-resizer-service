// –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –º–æ–¥—É–ª—ñ
import * as cron from 'node-cron';
import * as imageUtils from '../utils/imageUtils.js';
import fs from 'fs';
import { deleteImageByName, getAllImages } from '../services/imageService.js';

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å
export function scheduleCleanup() {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–æ–¥—É–ª—å node-cron –¥–ª—è –∑–∞–ø—É—Å–∫—É –∑–∞–¥–∞—á—ñ –æ—á–∏—â–µ–Ω–Ω—è –∫–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É
    cron.schedule('* * * * *', async () => {
        // –í–∏–≤–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ—á–∞—Ç–æ–∫ –∑–∞–¥–∞—á—ñ –æ—á–∏—â–µ–Ω–Ω—è
        console.log("üßπ Cleanup üßπ");
        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É —Ç–∞ —á–∞—Å
        const now = new Date();
        // –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å
        const images = await getAllImages();
        // –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –∫–æ–∂–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–æ–Ω–æ —Å—Ç–∞—Ä—ñ—à–µ 30 —Ö–≤–∏–ª–∏–Ω
        for (const image of images) {
            // –û—Ç—Ä–∏–º—É—î–º–æ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const imagePath = imageUtils.getImagePath(image);
            // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ñ–∞–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const stat = await fs.promises.stat(imagePath);
             // –û–±—á–∏—Å–ª—é—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é –≤ —á–∞—Å—ñ –º—ñ–∂ –ø–æ—Ç–æ—á–Ω–∏–º —á–∞—Å–æ–º —Ç–∞ —á–∞—Å–æ–º –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∑–º—ñ–Ω–∏ —Ñ–∞–π–ª—É
            const timeDifference = now.getTime() - stat.mtime.getTime();
            // –Ø–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ä—ñ—à–µ 30 —Ö–≤–∏–ª–∏–Ω, –≤–∏–¥–∞–ª—è—î–º–æ –π–æ–≥–æ
            if (timeDifference > 30 * 60 * 1000) {
                console.log('‚ùå –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ä—ñ—à–µ 30 —Ö–≤–∏–ª–∏–Ω, –≤–∏–¥–∞–ª—è—î–º–æ... ', image);
                await deleteImageByName(image);
            } else {
                // –Ø–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ —Å—Ç–∞—Ä—ñ—à–µ 30 —Ö–≤–∏–ª–∏–Ω, –≤–∏–≤–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ç–µ, —â–æ –π–æ–≥–æ –Ω–µ –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ
                console.log('üïë –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ —Å—Ç–∞—Ä—ñ—à–µ 30 —Ö–≤–∏–ª–∏–Ω:', image);
            }
        }
    });
}